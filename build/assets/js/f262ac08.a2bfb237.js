"use strict";(self.webpackChunkchargily_epay_docs=self.webpackChunkchargily_epay_docs||[]).push([[930],{3905:(e,t,a)=>{a.d(t,{Zo:()=>u,kt:()=>d});var n=a(7294);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function r(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?r(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):r(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function l(e,t){if(null==e)return{};var a,n,i=function(e,t){if(null==e)return{};var a,n,i={},r=Object.keys(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||(i[a]=e[a]);return i}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(n=0;n<r.length;n++)a=r[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(i[a]=e[a])}return i}var p=n.createContext({}),s=function(e){var t=n.useContext(p),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},u=function(e){var t=s(e.components);return n.createElement(p.Provider,{value:t},e.children)},c={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},h=n.forwardRef((function(e,t){var a=e.components,i=e.mdxType,r=e.originalType,p=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),h=s(a),d=i,m=h["".concat(p,".").concat(d)]||h[d]||c[d]||r;return a?n.createElement(m,o(o({ref:t},u),{},{components:a})):n.createElement(m,o({ref:t},u))}));function d(e,t){var a=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var r=a.length,o=new Array(r);o[0]=h;var l={};for(var p in t)hasOwnProperty.call(t,p)&&(l[p]=t[p]);l.originalType=e,l.mdxType="string"==typeof e?e:i,o[1]=l;for(var s=2;s<r;s++)o[s]=a[s];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}h.displayName="MDXCreateElement"},2681:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>p,contentTitle:()=>o,default:()=>c,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var n=a(7462),i=(a(7294),a(3905));const r={title:"Chargily ePay with Laravel",sidebar_label:"Laravel",sidebar_position:1,slug:"/epay-laravel"},o=void 0,l={unversionedId:"addons-for-frameworks/laravel",id:"addons-for-frameworks/laravel",title:"Chargily ePay with Laravel",description:"Laravel-Chargily-ePay",source:"@site/docs/addons-for-frameworks/laravel.md",sourceDirName:"addons-for-frameworks",slug:"/epay-laravel",permalink:"/docs/epay-laravel",draft:!1,editUrl:"https://github.com/Chargily/chargily-dev-docs/docs/addons-for-frameworks/laravel.md",tags:[],version:"current",sidebarPosition:1,frontMatter:{title:"Chargily ePay with Laravel",sidebar_label:"Laravel",sidebar_position:1,slug:"/epay-laravel"},sidebar:"tutorialSidebar",previous:{title:"Addons for frameworks",permalink:"/docs/category/addons-for-frameworks"},next:{title:"Django",permalink:"/docs/epay-django"}},p={},s=[{value:"Features",id:"features",level:2},{value:"Installation",id:"installation",level:2},{value:"Step 1 - Require the package",id:"step-1---require-the-package",level:3},{value:"Step 2: Publish migrations",id:"step-2-publish-migrations",level:3},{value:"Step 3: Run migrations",id:"step-3-run-migrations",level:3},{value:"Step 4: Edit <code>.env</code> file",id:"step-4-edit-env-file",level:3},{value:"Step 5: Epayable trait",id:"step-5-epayable-trait",level:3},{value:"Step 6 (optional): Publishing",id:"step-6-optional-publishing",level:3},{value:"Config File:",id:"config-file",level:4},{value:"Models",id:"models",level:4},{value:"Using the package",id:"using-the-package",level:2},{value:"Creating an Epay Invoice",id:"creating-an-epay-invoice",level:3},{value:"Creating an Epay Invoice for a User",id:"creating-an-epay-invoice-for-a-user",level:3},{value:"Payment Webhook",id:"payment-webhook",level:3},{value:"Testing your Webhook",id:"testing-your-webhook",level:4},{value:"Info",id:"info",level:2},{value:"Security",id:"security",level:3},{value:"License",id:"license",level:2}],u={toc:s};function c(e){let{components:t,...a}=e;return(0,i.kt)("wrapper",(0,n.Z)({},u,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("p",{align:"center"},(0,i.kt)("img",{src:"https://i.imgur.com/Do3DpYI.png"})),(0,i.kt)("h1",{align:"center"},"Laravel-Chargily-ePay"),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Laravel-Chargily-ePay")," is a Laravel package that provides an easy interface to ",(0,i.kt)("a",{parentName:"p",href:"http://pay.chargily.com/",title:"Chargily Pay gateway"},"Chargily Pay gateway"),"."),(0,i.kt)("h2",{id:"features"},"Features"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"Integrating E-Payment never was that fast and easy."),(0,i.kt)("li",{parentName:"ul"},"Creating invoices is as easy as calling a function."),(0,i.kt)("li",{parentName:"ul"},"Comes with a Migration that creates ",(0,i.kt)("inlineCode",{parentName:"li"},"epay_invoices")," table with a ",(0,i.kt)("inlineCode",{parentName:"li"},"user_id")," foreign id."),(0,i.kt)("li",{parentName:"ul"},"A trait for the User model that gives you some very useful functions like ",(0,i.kt)("inlineCode",{parentName:"li"},"$user->charge()")," to create an invoice for a user, and ",(0,i.kt)("inlineCode",{parentName:"li"},"$user->invoices()")," to get all user's invoices."),(0,i.kt)("li",{parentName:"ul"},"It comes with a payment webhook handler out of the box, so you just have to add your logic of what happens after a user performs a payment or cancels it."),(0,i.kt)("li",{parentName:"ul"},"It has a webhook tester built in, it's like a sandbox, it's a simulation of a user paying an invoice so you don't have to test your application with real money.")),(0,i.kt)("h2",{id:"installation"},"Installation"),(0,i.kt)("h3",{id:"step-1---require-the-package"},"Step 1 - Require the package"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"composer require thehocinesaad/laravel-chargily-epay\n")),(0,i.kt)("h3",{id:"step-2-publish-migrations"},"Step 2: Publish migrations"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'php artisan vendor:publish --provider="TheHocineSaad\\LaravelChargilyEPay\\LaravelChargilyEPayServiceProvider" --tag="migrations"\n')),(0,i.kt)("h3",{id:"step-3-run-migrations"},"Step 3: Run migrations"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},"php artisan migrate\n")),(0,i.kt)("h3",{id:"step-4-edit-env-file"},"Step 4: Edit ",(0,i.kt)("inlineCode",{parentName:"h3"},".env")," file"),(0,i.kt)("p",null,"This package requires these keys:"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"CHARGILY_EPAY_KEY"),": You can get it from ",(0,i.kt)("a",{parentName:"p",href:"https://pay.chargily.com/secure/admin/epay-api",title:"Chargily Pay's dashboard"},"Chargily Pay's dashboard"),".")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"CHARGILY_EPAY_SECRET"),": same as the first one.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"CHARGILY_EPAY_BACK_URL"),": This is the URL where the user will be redirected after payment processing.")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("p",{parentName:"li"},(0,i.kt)("strong",{parentName:"p"},"CHARGILY_EPAY_WEBHOOK_URL"),": This is the URL of your webhook where Chargily ePay will notify you after payment processing, we will talk about it in a bit."))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Important"),": ",(0,i.kt)("inlineCode",{parentName:"p"},"CHARGILY_EPAY_BACK_URL")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"CHARGILY_EPAY_WEBHOOK_URL")," should be real URLs, so you can't put ",(0,i.kt)("inlineCode",{parentName:"p"},"http://127.0.0.1:8000"),", use ",(0,i.kt)("a",{parentName:"p",href:"https://ngrok.com/",title:"Ngrok"},"Ngrok"),"."),(0,i.kt)("h3",{id:"step-5-epayable-trait"},"Step 5: Epayable trait"),(0,i.kt)("p",null,"Add the ",(0,i.kt)("inlineCode",{parentName:"p"},"Epayable")," trait to your User model:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"use  TheHocineSaad\\LaravelChargilyEPay\\Traits\\Epayable;\n\nclass User extends Authenticatable\n{\n    use Epayable\n}\n")),(0,i.kt)("h3",{id:"step-6-optional-publishing"},"Step 6 (optional): Publishing"),(0,i.kt)("h4",{id:"config-file"},"Config File:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'php artisan vendor:publish --provider="JohnDoe\\BlogPackage\\BlogPackageServiceProvider" --tag="config"\n')),(0,i.kt)("h4",{id:"models"},"Models"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre"},'php artisan vendor:publish --provider="TheHocineSaad\\LaravelChargilyEPay\\LaravelChargilyEPayServiceProvider" --tag="models"\n')),(0,i.kt)("h2",{id:"using-the-package"},"Using the package"),(0,i.kt)("h3",{id:"creating-an-epay-invoice"},"Creating an Epay Invoice"),(0,i.kt)("p",null,"To create an Invoice, you can te use the static ",(0,i.kt)("inlineCode",{parentName:"p"},"Make()")," function from the ",(0,i.kt)("inlineCode",{parentName:"p"},"Epay_Invoice")," model:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"use TheHocineSaad\\LaravelChargilyEPay\\Models\\Epay_Invoice;\n\n$configurations = [\n        'user_id' => 1, // (optional) This is the user ID to be added as a foreign key, it's optional, if it's not provided its value will be NULL\n        'mode' => 'CIB', // Payment method must be 'CIB' or 'EDAHABIA'\n        'payment' => [\n         'client_name' => 'client name here', // Client name\n         'client_email' => 'hello@email.com', // This is where client receives payment receipt after confirmation\n            'amount' => 2500, // Must be = or > than 75 \n            'discount' => 0, // This is discount percentage, between 0 and 99\n            'description' => 'payment for product', // This is the payment description\n        ]\n    ];\n\n    $checkout_url = Epay_Invoice::make($configurations);\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Make()")," function returns the checkout URL, where the user should be redirected to make a payment, If any error occurs, it will return to the home page, so make sure to check this before redirecting the user."),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"Make()")," also creates an invoice in your database using the info from the provided ",(0,i.kt)("strong",{parentName:"p"},"$configurations")," array, so if you added columns to the migration file of the invoices table that comes with the package, you have to add the corresponding values as a second array, example:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"    $checkout_url = Epay_Invoice::make($configurations, ['product_id' => 1]);\n")),(0,i.kt)("p",null,"As you saw in the example above, we added the value of ",(0,i.kt)("inlineCode",{parentName:"p"},"product_id"),", that's because you may be added ",(0,i.kt)("inlineCode",{parentName:"p"},"product_id")," field in the migration file."),(0,i.kt)("h3",{id:"creating-an-epay-invoice-for-a-user"},"Creating an Epay Invoice for a User"),(0,i.kt)("p",null,"The other way (Recommended way) to create Epay Invoices is to use the ",(0,i.kt)("inlineCode",{parentName:"p"},"charge()")," custom model method which is provided by the ",(0,i.kt)("inlineCode",{parentName:"p"},"Epayable")," trait, this method will automatically add the name of the client, the email of the client, and the ",(0,i.kt)("inlineCode",{parentName:"p"},"client_id")," foreign key:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"$configurations = [\n    'mode' => 'CIB',\n    'payment' => [\n        'amount' => 1000,\n        'discount' => 0,\n        'description' => 'payment for product',\n    ]\n];\n\n$checkout_url = $request->user()->charge($configurations);\n")),(0,i.kt)("p",null,"The ",(0,i.kt)("inlineCode",{parentName:"p"},"charge()")," method calls the ",(0,i.kt)("inlineCode",{parentName:"p"},"Make()")," static function at a certain point, so they act the same way, it returns the checkout URL, or the home page URL if any error occurs."),(0,i.kt)("p",null,"Just like the ",(0,i.kt)("inlineCode",{parentName:"p"},"Make()")," function, you can add a second array to pass any added columns to the ",(0,i.kt)("inlineCode",{parentName:"p"},"invoices")," table."),(0,i.kt)("h3",{id:"payment-webhook"},"Payment Webhook"),(0,i.kt)("p",null,"After a user complete the payment of an invoice, Chargily ePay will notify you by sending a post request to your Webhook, so you can handle the things you would like to happen after a successful or a failed payment."),(0,i.kt)("p",null,"So, go ahead and create a ",(0,i.kt)("inlineCode",{parentName:"p"},"POST"),' Route (ex: "/webhook"), by the way, this is the URL you should add to the ',(0,i.kt)("inlineCode",{parentName:"p"},"CHARGILY_EPAY_WEBHOOK_URL")," key in the ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," file."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Important"),": You have to exclude this URL from CSRF verification, to do so, add it to the ",(0,i.kt)("inlineCode",{parentName:"p"},"except")," method in your applications's ",(0,i.kt)("inlineCode",{parentName:"p"},"App\\Http\\Middleware\\VerifyCsrfToken")," middleware:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"protected $except = [\n        'webhook'\n];\n")),(0,i.kt)("p",null,"Here is the code you should put in this route as a starting point:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"use TheHocineSaad\\LaravelChargilyEPay\\Epay_Webhook;\n\n$webhookHandler = new Epay_Webhook;\n\nif($webhookHandler -> invoiceIsPaied) {\n    // Put here the logic you want to happen if the user actually made the payment.\n}else {\n    // Put here the logic you want to happen if the user canceled the payment.\n}\n")),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note"),": You can access the ID of the Invoice by: ",(0,i.kt)("inlineCode",{parentName:"p"},"$webhookHandler -> invoice['invoice_number']")),(0,i.kt)("p",null,"Here is an example of the data that comes with the post request from Chargily Pay:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-json"},'{\n   "invoice":{\n      "id":100000,\n      "client":"Test Client",\n      "client_email":"testclient@mail.com",\n      "invoice_number":"I-123456789",\n      "status":"paid",\n      "amount":5000,\n      "fee":75,\n      "discount":0,\n      "due_amount":5075,\n      "comment":"Payment for T-Shirt",\n      "mode":"CIB",\n      "new":1,\n      "tos":1,\n      "back_url":"https://www.domain.com/",\n      "invoice_token":"random_token_here",\n      "api_key_id":null,\n      "meta_data":null,\n      "due_date":"2022-04-27 00:00:00",\n      "created_at":"2022-04-27 20:59:07",\n      "updated_at":"2022-04-27 21:01:09"\n   }\n}\n')),(0,i.kt)("h4",{id:"testing-your-webhook"},"Testing your Webhook"),(0,i.kt)("p",null,"I added an internal feature to simulate a payment of an invoice to test your webhook without the need to use Postman, after installing this package, you will automatically have a new route ",(0,i.kt)("inlineCode",{parentName:"p"},"/epay-webhook-tester"),", navigate to it, put the ID of the invoice you want to simulate its payment and click on PAY."),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Important: ")," When you run your application using the local server ",(0,i.kt)("inlineCode",{parentName:"p"},"php artisan serve"),", it will work on a single thread, so making post requests to itself will give you a timeout error, on a server, this is not a problem because it will use Apache or Nginx, the solution is to start another local server on another port (ex: 8001) and use this feature from there.\nExample: "),(0,i.kt)("ol",null,(0,i.kt)("li",{parentName:"ol"},"Run ",(0,i.kt)("inlineCode",{parentName:"li"},"php artisan serve")," so you will have your app on ",(0,i.kt)("inlineCode",{parentName:"li"},"http://127.0.0.1:8000"),"."),(0,i.kt)("li",{parentName:"ol"},"In another terminal instance, run ",(0,i.kt)("inlineCode",{parentName:"li"},"php artisan serve --port=8001")," then visit ",(0,i.kt)("inlineCode",{parentName:"li"},"http://127.0.0.1:8001/epay-webhook-tester"),", not ",(0,i.kt)("inlineCode",{parentName:"li"},"http://127.0.0.1:8000/epay-webhook-tester"))),(0,i.kt)("p",null,(0,i.kt)("strong",{parentName:"p"},"Note: "),"for security purposes, this feature works only on the local environment (",(0,i.kt)("inlineCode",{parentName:"p"},"APP_ENV=local"),"), and am sure it's not needed in production."),(0,i.kt)("p",null,(0,i.kt)("img",{parentName:"p",src:"https://i.imgur.com/k2yaVSt.png",alt:"Test Chargily Pay"})),(0,i.kt)("h2",{id:"info"},"Info"),(0,i.kt)("p",null,"This Laravel package is built on top of ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/Chargily/chargily-epay-php",title:"this PHP package"},"this PHP package"),", so have a look at it to know more about what's happening under the hood."),(0,i.kt)("h3",{id:"security"},"Security"),(0,i.kt)("p",null,"If you discover any security related issues, please email ",(0,i.kt)("a",{parentName:"p",href:"mailto:theHocineSaad@gmail.com"},"theHocineSaad@gmail.com")," instead of using the issue tracker."),(0,i.kt)("h2",{id:"license"},"License"),(0,i.kt)("p",null,"Laravel-Chargily-ePay project is open-sourced software licensed under the ",(0,i.kt)("a",{parentName:"p",href:"https://github.com/theHocineSaad/laravel-chargily-epay/blob/main/LICENSE.md",title:"MIT license"},"MIT license"),"."))}c.isMDXComponent=!0}}]);